---
title: "Confidence interval interpretation"
author: "Giuseppe Tinti Tomio"
output:
    xaringan::moon_reader:
        self_contained: yes
        nature:
            highlightStyle: github
            highlightLines: true
            countIncrementalSlides: false
---

```{css css setup, echo = FALSE}
.pull-left-70 {
    float: left;
    width: 63%;
}
.pull-right-30 {
    float: right;
    width: 32%;
}

.big {
    font-size: 25px;
}

.right {
    float : right;
}

.orange {
    color: #E69F00;
}

.green {
    color: #009E73;
}

.blue {
    color: #0072B2;
}
```

```{r R setup, include = FALSE}
knitr::opts_chunk$set(
    echo = FALSE,
    fig.align = "center",
    fig.height = 7,
    fig.width = 10,
    out.height = "100%"
)

library(tidyverse)
library(xkcd)

POPULATION_SIZE <- 20
TRUE_LOCATION <- 170
TRUE_SCALE <- 10

SEED <- 42

# RED <- scales::hue_pal()(2)[1]
# BLUE <- scales::hue_pal()(2)[2]
ORANGE <- "#E69F00"
GREEN <- "#009E73"
BLUE <- "#0072B2"
BASE_SIZE <- 22

plot_stickmen <- function(
    column_count,
    row_count,
    is_selected = FALSE
) {
    data <- generate_stickmen_data(column_count, row_count, is_selected)

    plot <-
        ggplot() +
        xkcdman(aes(
            x = x,
            y = y,
            scale = draw_height,
            ratioxy = xy_ratio,
            angleofspine = spine_angle,
            anglelefthumerus = lefth_humerus_angle,
            anglerighthumerus = right_humerus_angle,
            angleleftradius = left_radius_angle,
            anglerightradius = right_radius_angle,
            angleleftleg = left_leg_angle,
            anglerightleg = right_leg_angle,
            angleofneck = neck_angle,
            color = is_selected
        ), data) +
        scale_color_manual(values = c(`TRUE` = ORANGE, `FALSE` = BLUE), guide = "none") +
        scale_x_continuous(expand = expansion(add = 0)) +
        scale_y_continuous(expand = expansion(add = 0)) +
        theme_void()

    return(plot)
}

generate_stickmen_data <- function(
    column_count,
    row_count,
    is_selected
) {
    total_count <- column_count * row_count

    x <- rep(seq(0, column_count - 1), times = row_count)
    y <- - 4 * rep(seq(0, row_count - 1), each = column_count)
    draw_height <- 1
    xy_ratio <- diff(range(x)) / diff(range(y))

    down <- - pi / 2
    tilt <- pi / 12
    left_tilted <- down + tilt
    right_tilted <- down - tilt

    data <- tibble(
        x = x,
        y = y,
        draw_height = draw_height,
        xy_ratio = xy_ratio,
        spine_angle = down,
        lefth_humerus_angle = left_tilted,
        right_humerus_angle = right_tilted,
        left_radius_angle = left_tilted,
        right_radius_angle = right_tilted,
        left_leg_angle = left_tilted,
        right_leg_angle = right_tilted,
        neck_angle = down,
        is_selected = is_selected
    )

    return(data)
}

base_theme <- function(

) {
    return(theme_minimal(BASE_SIZE))
}

set.seed(SEED)
```

```{r reference setup, include = FALSE, cache = FALSE}
library(RefManageR)

bibliography <- ReadBib("./bibliography.bib")

BibOptions(
    bib.style = "authoryear",
    max.names = 1,
    cite.style = "authoryear",
    style = "markdown",
    hyperlink = FALSE
)

Citet(bibliography, "shields2011bias")
```

```{r processing, include = FALSE}
```

.pull-left-70[
```{r, fig.height = 8, fig.width = 6}
plot_stickmen(
    column_count = 4,
    row_count = 4,
    is_selected = rbernoulli(4 * 4, 1/4)
)
```
]

.pull-right-30.big[
$$h = 170 \text{ cm}$$

.orange[$$\widehat{\mu} = 180 \text{ cm}$$]

.orange[$$\widehat{\sigma} = 10 \text{ cm}$$]

.orange[$$\text{CI} = [170 \text{ cm}, 190 \text{ cm}]$$]

.orange[$$(\text{CI} = [\widehat{\mu} - \widehat{\sigma}, \widehat{\mu} + \widehat{\sigma}])$$]
]

---
```{r, fig.height = 8, fig.width = 12}
EXPERIMENT_COUNT <- 50
POPULATION_SIZE <- 5
confidence_level <- 80 / 100

data <- tibble(
    index = seq(EXPERIMENT_COUNT),
    sample = replicate(EXPERIMENT_COUNT, list(rnorm(POPULATION_SIZE, TRUE_LOCATION,  TRUE_SCALE)))
)

data <-
    data %>%
    rowwise() %>%
    mutate(location = mean(sample), scale = sd(sample) / sqrt(POPULATION_SIZE)) %>%
    ungroup()

data <-
    data %>%
    mutate(
        lower_ci = location - qt(1 - (1 - confidence_level) / 2, POPULATION_SIZE) * scale / sqrt(POPULATION_SIZE),
        upper_ci = location + qt(1 - (1 - confidence_level) / 2, POPULATION_SIZE) * scale / sqrt(POPULATION_SIZE)
    ) %>%
    mutate(is_covering = (lower_ci < TRUE_LOCATION) & (TRUE_LOCATION < upper_ci))

data %>%
    ggplot(aes(x = index, ymin = lower_ci, ymax = upper_ci, color = is_covering)) +
    geom_hline(yintercept = TRUE_LOCATION, size = 2) +
    geom_errorbar(size = 2, width = 0) +
    scale_x_continuous(breaks = NULL) +
    scale_y_continuous(breaks = seq(150, 190, 10), labels = ~ str_glue("{.x}\ncm"), limits = c(150, 190)) +
    scale_color_manual(values = c(`TRUE` = GREEN, `FALSE` = ORANGE), guide = "none") +
    labs(
        x = NULL,
        y = NULL
    ) +
    theme_minimal(22)
```

.right[Confidence level `r scales::percent(confidence_level)`]

---
# Example

This:
- `r Citet(bibliography, "shields2011bias")` report a 95% CI of [174cm, 175cm] for the height of the average Canadian man

Means:
- The average Canadian men is estimated to be between 174cm and 175cm tall.
- We can be confident of this estimate, because if a lot of scientists replicated the experiment, we would expect 95% of them to be correct

---
# Reference

```{r references, echo = FALSE, results = "asis"}
PrintBibliography(bibliography)
```
